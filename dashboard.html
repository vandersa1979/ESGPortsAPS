<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Novo Atestado • Água de Lastro • MAV-IT</title>
<link rel="stylesheet" href="style.css">
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.min.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.worker.min.js"></script>
<style>
  /* ESTILOS DA BARRA DE CARREGAMENTO (INCORPORADOS PARA GARANTIR O FUNCIONAMENTO) */
  .bottom-loader-container {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: #1C1E87; /* Cor primária */
    color: white;
    z-index: 1000;
    padding: 20px 30px;
    box-shadow: 0 -4px 20px rgba(28, 30, 135, 0.25);
    transform: translateY(100%);
    transition: transform 0.4s ease-in-out;
  }
  .bottom-loader-container.visible {
    transform: translateY(0);
  }
  .bottom-loader-content {
    max-width: 1200px;
    margin: 0 auto;
    text-align: center;
  }
  .bottom-loader-content p {
    margin: 0 0 12px 0;
    font-weight: 600;
    font-size: 16px;
    font-family: 'Inter', sans-serif;
  }
  .bottom-loader-progress {
    width: 100%;
    height: 8px;
    background-color: rgba(255, 255, 255, 0.25);
    border-radius: 99px;
    overflow: hidden;
  }
  #bottom-loader-bar {
    height: 100%;
    width: 0%;
    background-color: #F7C9AF; /* Cor de destaque */
    border-radius: 99px;
  }
</style>
</head>
<body>
  <div class="page-wrapper">
    <aside class="sidebar">
      <div class="brand"><div class="logoDot"></div><div class="brandText">MAV‑IT • BW COMP</div></div>
      <nav class="sidebar-nav">
        <a href="dashboard.html" class="nav-item active">Novo Atestado</a>
        <a href="minhas-requisicoes.html" class="nav-item">Minhas Requisições</a>
        <a href="meus-atestados.html" class="nav-item">Meus Atestados</a>
        <a href="arquivados.html" class="nav-item">Arquivados</a>
        <a href="cadastro-usuarios.html" class="nav-item">Cadastro de Usuários</a>
        <a href="financeiro.html" class="nav-item">Financeiro</a>
        <a href="suporte.html" class="nav-item">Suporte Técnico</a>
      </nav>
      <div class="sidebar-footer">
        <a href="index.html" onclick="localStorage.clear()">Sair</a>
      </div>
    </aside>
    <main class="main-content">
      <div class="container">
        <div class="grid cols-2">
          <div class="card">
            <h2 class="section-title">Dados da Operação</h2>
            <div class="sub">Preencha os campos obrigatórios para iniciar a análise.</div>
            <div class="field-row"><div class="lab">Embarcação (Controle Interno)</div><input class="input" id="nome_embarcacao"></div>
            <div class="field-row"><div class="lab">Código IMO</div><input class="input" id="imo"></div>
            <div class="field-row"><div class="lab">Carga</div><input class="input" id="carga"></div>
            <div class="field-row"><div class="lab">Tipo de Gerenciamento</div>
              <select class="input" id="tipo_gerenciamento">
                <option value="D1">D1</option>
                <option value="D2">D2</option>
              </select>
            </div>
            <div class="field-row"><div class="lab">Tipo de Operação</div>
              <select class="input" id="tipo_operacao">
                <option>TRAMP</option>
                <option>LINER</option>
                <option>CABOTAGEM</option>
                <option>CONTAINER</option>
                <option>EMPRESA BRASILEIRA DE NAVEGAÇÃO</option>
                <option>CRUISE VESSELS</option>
              </select>
            </div>
          </div>

          <div class="card">
            <h2 class="section-title">Uploads Obrigatórios</h2>
            <div class="sub">Selecione os 4 PDFs exatamente nos modelos fornecidos.</div>
            <div class="field-row"><div class="lab">1.1 — IBWMC</div><input class="input" id="file_ibwmc" type="file" accept="application/pdf"></div>
            <div class="small" style="margin:-12px 0 12px 196px">International Ballast Water Management Certificate.</div>
            <div class="field-row"><div class="lab">1.2 — IBWMS</div><input class="input" id="file_ibwms" type="file" accept="application/pdf"></div>
            <div class="small" style="margin:-12px 0 12px 196px">Certificação do Sistema de Gestão de Água de Lastro (BWMS).</div>
            <div class="field-row"><div class="lab">1.3 — BWRF</div><input class="input" id="file_bwrf" type="file" accept="application/pdf"></div>
            <div class="small" style="margin:-12px 0 12px 196px">Ballast Water Report Form.</div>
            <div class="field-row"><div class="lab">1.4 — IBWMP</div><input class="input" id="file_ibwmp" type="file" accept="application/pdf"></div>
            <div class="small" style="margin:-12px 0 12px 196px">Ballast Water Management Plan.</div>

            <div id="status" class="small" style="margin-top:12px; color: var(--error); font-weight: bold;"></div>
            <div style="display:flex;gap:10px;margin-top:12px">
              <button class="btn" id="btn_processar" onclick="processar()">Validar & Gerar Requisição</button>
              <button class="btn secondary" id="btn_limpar" onclick="limpar()">Limpar</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <div id="bottom-loader" class="bottom-loader-container">
    <div class="bottom-loader-content">
        <p id="bottom-loader-message">ANÁLISE COMPARATIVA COM INTELIGÊNCIA ARTIFICIAL</p>
        <div class="bottom-loader-progress">
            <div id="bottom-loader-bar"></div>
        </div>
    </div>
  </div>

<script>
// --- INÍCIO DO BLOCO DE UTILIDADES ---
if(!localStorage.getItem('usuarioLogado')) window.location.href='index.html';

function getAccountEmail() {
  return localStorage.getItem('contaPrincipal') || localStorage.getItem('usuarioLogado') || 'anon';
}

function getDb(){
  const key = 'mav_it_data_' + getAccountEmail();
  const defaults = { requisicoes: [], atestados: [], arquivados: [], usuarios: [], faturamento: {}, tickets: [] };
  try {
    const db = JSON.parse(localStorage.getItem(key));
    if (!db) return defaults;
    for(const k in defaults) { if(!db[k]) db[k] = defaults[k]; }
    return db;
  } catch(e) { return defaults; }
}

function saveDb(db){
  const key = 'mav_it_data_' + getAccountEmail();
  localStorage.setItem(key, JSON.stringify(db));
}
// --- FIM DO BLOCO DE UTILIDADES ---

pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.worker.min.js';

function setProgress(p){ 
  document.getElementById('bottom-loader-bar').style.width = p+'%'; 
}

function readPdfFile(file){
  return new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onload = async () => {
      try {
        const typed = new Uint8Array(fr.result);
        const pdf = await pdfjsLib.getDocument({data:typed}).promise;
        let fullText = "";
        for(let i=1;i<=pdf.numPages;i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          const strings = content.items.map(it => it.str);
          fullText += strings.join("\n") + "\n";
        }
        resolve(fullText);
      } catch(err){ reject(err); }
    };
    fr.onerror = reject;
    fr.readAsArrayBuffer(file);
  });
}

function parseIBWMC(text){
  const pick = (re) => (text.match(re)||[])[1]?.trim() || null;
  return {
    source:'IBWMC', shipName: pick(/Name of ship\s+(.+?)\n/i), imo: pick(/IMO\s*number.*?(\d{7})/i), port: pick(/Port of registry\s+(.+?)\n/i),
    gt: pick(/Gross\s*Tonnage\s+([\d\.,]+)/i), method: /D-2|Regulation\s*D-2/i.test(text) ? 'D-2' : (/D-1|Regulation\s*D-1/i.test(text) ? 'D-1':'N/A'),
    manufacturer: pick(/Name of manufacturer.*?\n(.+?)\n/i) || (text.match(/Headway|Alfa Laval|DESMI|Ecochlor/i)?.[0]||null),
    installDate: pick(/Date installed.*?([0-9]{1,2}\s*\w+\s*[0-9]{4}|[0-9]{2}[\/\.][0-9]{2}[\/\.][0-9]{4})/i), validUntil: pick(/valid\s*until\s*([A-Za-z0-9 ,\/]+)/i)
  };
}
function parseIBWMS(text){
  const pick = (re) => (text.match(re)||[])[1]?.trim() || null;
  return {
    source:'IBWMS', approval: pick(/Approval\s*Number[:\s]+([\d\.\/]+)/i), expires: pick(/Expires[:\s]+(.+?)\n/i),
    bwmsName: pick(/Name of BWMS[:\s]+(.+?)\n/i) || (text.match(/OceanGuard|Hyde Guardian|BWTS/i)?.[0]||null),
    manufacturer: (text.match(/Headway Technology Group|Alfa Laval|DESMI|Ecochlor/i)?.[0]||null), capacities: pick(/Capacities[:\s]+(.+?)\n/i)
  };
}
function parseBWRF(text){
  const pick = (re) => (text.match(re)||[])[1]?.trim() || null;
  return {
    source:'BWRF', shipName: pick(/Vessel\s*Name[:\s]+(.+?)\n/i), arrivalPort: pick(/Arrival\s*Port[:\s]+(.+?)\n/i), arrivalDate: pick(/Arrival\s*Date.*?[:\s]+(.+?)\n/i),
    totalOnBoard: pick(/Total\s*ballast\s*water\s*on\s*board.*?([\d\.,]+)/i), totalToDischarge: pick(/Total\s*ballast\s*water\s*to\s*be\s*discharged.*?([\d\.,]+)/i),
    bwmsUsed: /\)\s*BWMS\s*\)|\(\s*√\s*\)\s*BWMS|BWMS\s+YES/i.test(text) ? 'YES' : ( /BWE/i.test(text) ? 'BWE':'N/A')
  };
}
function parseIBWMP(text){
  const pick = (re) => (text.match(re)||[])[1]?.trim() || null;
  return {
    source:'IBWMP', shipName: pick(/Ship[’'`s]*\s*name.*?\n\s*(.+?)\n/i), flag: pick(/Flag\s+(.+?)\n/i),
    methodPrimary: /D-2/i.test(text) ? 'D-2' : null, methodContingency: /D-1/i.test(text) ? 'D-1' : null,
    officer: pick(/Ballast\s*Water\s*Management\s*Officer.*?\n\s*(.+?)\n/i)
  };
}

function compareAll(inputs, docs){
  const findings = [];
  function add(field, label, values, labels){
    const originalValues = values.filter(v => v != null).map(v => v.toString().trim());
    const processedValues = originalValues.map(v => v.toLowerCase());
    const uniq = Array.from(new Set(processedValues));
    const match = uniq.length <= 1 && originalValues.length > 0;
    findings.push({ field, label, values: processedValues, valuesOriginal: originalValues, match, labels });
  }
  
  add('shipName','Nome da Embarcação',[inputs.nome_embarcacao, docs.IBWMC?.shipName],['Digitado','IBWMC']);
  add('imo','IMO',[inputs.imo, docs.IBWMC?.imo],['Digitado','IBWMC']);
  add('arrivalPort','Porto de chegada',[docs.BWRF?.arrivalPort],['BWRF']);
  add('arrivalDate','Data de chegada',[docs.BWRF?.arrivalDate],['BWRF']);
  add('totalOnBoard','Volume a bordo (m³)',[docs.BWRF?.totalOnBoard],['BWRF']);
  add('totalToDischarge','Volume a descarregar (m³)',[docs.BWRF?.totalToDischarge],['BWRF']);
  add('method','Método (D-1/D-2)',[docs.IBWMC?.method, docs.IBWMP?.methodPrimary],['IBWMC','IBWMP']);
  add('manufacturer','Fabricante do BWMS',[docs.IBWMC?.manufacturer, docs.IBWMS?.manufacturer],['IBWMC','IBWMS']);
  return findings;
}

function processar(){
  const required=['nome_embarcacao','imo','carga','tipo_gerenciamento','tipo_operacao','file_ibwmc','file_ibwms','file_bwrf','file_ibwmp'];
  for(const id of required){
    const el=document.getElementById(id);
    if(!el || (el.type!=='file' && !el.value) || (el.type==='file' && !el.files[0])){ 
      document.getElementById('status').textContent='Preencha todos os campos e selecione os 4 PDFs.'; return; 
    }
  }

  const loader = document.getElementById('bottom-loader');
  const statusEl = document.getElementById('status');
  const btnProcessar = document.getElementById('btn_processar');
  const btnLimpar = document.getElementById('btn_limpar');

  loader.style.display = 'block';
  setTimeout(() => {
    loader.classList.add('visible');
  }, 50);

  statusEl.textContent = '';
  btnProcessar.disabled = true;
  btnLimpar.disabled = true;
  setProgress(0);
  
  let startTime = null;
  const duration = 10000;
  let animationFrameId;

  function animationLoop(timestamp) {
      if (!startTime) startTime = timestamp;
      const elapsedTime = timestamp - startTime;
      const progress = Math.min((elapsedTime / duration) * 100, 100);
      setProgress(progress);

      if (elapsedTime < duration) {
          animationFrameId = requestAnimationFrame(animationLoop);
      }
  }
  animationFrameId = requestAnimationFrame(animationLoop);

  setTimeout(async () => {
    try {
      cancelAnimationFrame(animationFrameId);
      const [t1,t2,t3,t4] = await Promise.all([
        readPdfFile(document.getElementById('file_ibwmc').files[0]),
        readPdfFile(document.getElementById('file_ibwms').files[0]),
        readPdfFile(document.getElementById('file_bwrf').files[0]),
        readPdfFile(document.getElementById('file_ibwmp').files[0])
      ]);

      const d1=parseIBWMC(t1), d2=parseIBWMS(t2), d3=parseBWRF(t3), d4=parseIBWMP(t4);
      const inputs={
        nome_embarcacao: document.getElementById('nome_embarcacao').value.trim(),
        imo: document.getElementById('imo').value.trim(),
        carga: document.getElementById('carga').value.trim(),
        tipo_gerenciamento: document.getElementById('tipo_gerenciamento').value,
        tipo_operacao: document.getElementById('tipo_operacao').value,
        porto_chegada: d3.arrivalPort, data_chegada: d3.arrivalDate, volume_bordo: d3.totalOnBoard, volume_descarga: d3.totalToDischarge
      };
      const docs={ IBWMC:d1, IBWMS:d2, BWRF:d3, IBWMP:d4 };
      const findings=compareAll(inputs,docs);
      const diverg = findings.filter(f=>!f.match);
      const approved = diverg.length === 0;

      const now = new Date();
      const ts = now.toLocaleString(undefined,{dateStyle:'short', timeStyle:'short', hour12:false});
      const payload = JSON.stringify({inputs, docs, findings, ts, approved});
      const enc = new TextEncoder().encode(payload);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      const hashArr = Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
      
      const snapshot = {inputs, docs, findings, ts, approved, hash: hashArr};
      
      const newRequisicao = {
        id: 'req_' + Date.now(),
        ship: inputs.nome_embarcacao,
        imo: inputs.imo,
        port: inputs.porto_chegada,
        tipo: inputs.tipo_gerenciamento,
        ts: ts,
        status: approved ? 'Aprovado' : 'Reprovado',
        snapshot: snapshot
      };

      const db = getDb();
      db.requisicoes.unshift(newRequisicao);
      saveDb(db);
      
      window.location.href='minhas-requisicoes.html';

    } catch(err) {
      cancelAnimationFrame(animationFrameId);
      loader.classList.remove('visible');
      setTimeout(() => { loader.style.display = 'none'; }, 400);
      statusEl.textContent='Falha na leitura ou processamento de algum PDF. Erro: ' + err.message;
      btnProcessar.disabled = false;
      btnLimpar.disabled = false;
      setProgress(0);
    }
  }, duration);
}

function limpar(){
  document.getElementById('nome_embarcacao').value = '';
  document.getElementById('imo').value = '';
  document.getElementById('carga').value = '';
  document.getElementById('file_ibwmc').value = '';
  document.getElementById('file_ibwms').value = '';
  document.getElementById('file_bwrf').value = '';
  document.getElementById('file_ibwmp').value = '';
  document.getElementById('status').textContent='';
}
</script>
</body>
</html>
