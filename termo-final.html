<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ATESTADO DE CONFORMIDADE • Água de Lastro • MAV-IT</title>
<link rel="stylesheet" href="style.css">
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
  <div class="page-wrapper">
    <aside class="sidebar">
      <div class="brand"><div class="logoDot"></div><div class="brandText">MAV‑IT • BW COMP</div></div>
      <nav class="sidebar-nav">
        <a href="dashboard.html" class="nav-item">Novo Atestado</a>
        <a href="minhas-requisicoes.html" class="nav-item">Minhas Requisições</a>
        <a href="meus-atestados.html" class="nav-item">Meus Atestados</a>
        <a href="arquivados.html" class="nav-item">Arquivados</a>
        <a href="cadastro-usuarios.html" class="nav-item">Cadastro de Usuários</a>
        <a href="financeiro.html" class="nav-item">Financeiro</a>
        <a href="suporte.html" class="nav-item">Suporte Técnico</a>
      </nav>
      <div class="sidebar-footer">
        <a href="index.html" onclick="localStorage.clear()">Sair</a>
      </div>
    </aside>
    <main class="main-content">
      <div class="container" id="capture">
        <div class="card">
          <div class="header no-print" style="padding: 0; margin-bottom: 20px;">
             <div class="brand"><div class="logoDot"></div><div class="brandText">MAV‑IT • BW COMP</div></div>
             <div class="docTitle">ATESTADO DE CONFORMIDADE</div>
          </div>
          
          <table class="table" style="margin-bottom: 16px;">
            <tr>
              <th>Status</th><td id="statusCell"></td>
              <th>Base legal</th><td>Art. 13 da NAP.SUMAS.OPR 023.2024</td>
            </tr>
          </table>

          <h2 class="section-title">1) Identificação do Navio</h2>
          <div class="grid cols-2">
            <div class="field-row"><div class="lab">Embarcação</div><div id="f_ship"></div></div>
            <div class="field-row"><div class="lab">IMO</div><div id="f_imo"></div></div>
            <div class="field-row"><div class="lab">Porto de chegada</div><div id="f_port"></div></div>
            <div class="field-row"><div class="lab">Data de chegada</div><div id="f_date"></div></div>
          </div>

          <h2 class="section-title" style="margin-top: 16px;">2) Certificados</h2>
          <table class="table">
            <tr><th>IBWMC</th><td id="ibwmc_desc"></td><th>Validade</th><td id="ibwmc_valid"></td></tr>
            <tr><th>IBWMS (USCG)</th><td id="ibwms_desc"></td><th>Expira</th><td id="ibwms_exp"></td></tr>
          </table>

          <h2 class="section-title" style="margin-top: 16px;">3) Crítica de Conformidade</h2>
          <table class="table" id="tbl-div">
            <thead><tr><th>Campo</th><th>Valores Apresentados</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>

          <h2 class="section-title" style="margin-top: 16px;">4) Resumo das Não Conformidades (texto)</h2>
          <div id="nc-text" class="small"></div>

          <div class="sigCenter">
            <div class="sigName">MAV‑IT</div>
            <div class="sigRole"><b>MAV‑IT TECNOLOGIA EM INTELIGÊNCIA ARTIFICIAL PARA SEGURANÇA DE PORTOS</b></div>
            <div class="sigGov">ASSINATURA DIGITAL GOVERNAMENTAL — CNPJ 60.753.111/0001-09</div>
            <div class="sigStamp"><b>Timestamp:</b> <span id="ts"></span> &nbsp;•&nbsp; <b>SHA‑256:</b> <span id="hash"></span></div>
          </div>
        </div>
      </div>
    </main>
  </div>
    
  <div class="container no-print" style="padding-top:0;">
    <div style="display:flex;justify-content:flex-end;gap:10px;">
      <button class="btn" onclick="baixarPDF()">Baixar PDF (1 folha)</button>
      <button class="btn secondary" onclick="window.print()">Imprimir</button>
      <button class="btn secondary" onclick="history.back()">Voltar</button>
    </div>
  </div>


<script>
function buildNcText(diverg){
  if(diverg.length===0){
    return '<span class="badge ok">Sem não conformidades</span>';
  }
  const lines = diverg.map(f=>{
    const labs = f.labels || [];
    const pairs = (f.valuesOriginal || f.values).map((v,i)=>`${labs[i]||('Fonte '+(i+1))}: "${String(v)}"`).join('; ');
    return `• <b>${f.label}:</b> ${pairs}.`;
  });
  return '<ul style="margin:6px 0 0 16px; padding-left: 16px;"><li>'+lines.join('</li><li>')+'</li></ul>';
}

function fill(){
  const fromHistory = JSON.parse(localStorage.getItem('bw_snapshot')||'null');
  if(!fromHistory) {
      document.body.innerHTML = '<h1>Erro: Nenhum snapshot encontrado para exibir.</h1><p>Por favor, volte e selecione um atestado para visualizar.</p><button onclick="history.back()">Voltar</button>';
      return;
  }
  
  const inputs = fromHistory?.inputs || {};
  const docs = fromHistory?.docs || {};
  const findings = fromHistory?.findings || [];

  const get = (v)=> v==null||v===''?'-':String(v);
  document.getElementById('f_ship').textContent = get(inputs.nome_embarcacao);
  document.getElementById('f_imo').textContent = get(inputs.imo);
  document.getElementById('f_port').textContent = get(inputs.porto_chegada);
  document.getElementById('f_date').textContent = get(inputs.data_chegada);

  const ibwmc = docs.IBWMC || {}; const ibwms = docs.IBWMS || {};
  document.getElementById('ibwmc_desc').textContent = get(`Método ${ibwmc.method||'n/d'} • Fabricante ${ibwmc.manufacturer||'n/d'}`);
  document.getElementById('ibwmc_valid').textContent = get(ibwmc.validUntil||'n/d');
  document.getElementById('ibwms_desc').textContent = get(`${ibwms.bwmsName||'n/d'} • Approval ${ibwms.approval||'n/d'}`);
  document.getElementById('ibwms_exp').textContent = get(ibwms.expires||'n/d');

  const tbody = document.querySelector('#tbl-div tbody');
  tbody.innerHTML = '';
  
  // A tabela agora mostra TODOS os findings, sem filtro, garantindo consistência.
  findings.forEach(f=>{
      const tr = document.createElement('tr');
      const labs = f.labels || [];
      const vals = (f.valuesOriginal || f.values).map((v,i)=>`${labs[i]?('<b>'+labs[i]+':</b> '):''}${String(v)}`).join(' • ');
      const statusBadge = f.match ? '<span class="badge ok">CONFORME</span>' : '<span class="badge error">NÃO CONFORME</span>';
      tr.innerHTML = `<td>${f.label}</td><td>${vals}</td><td>${statusBadge}</td>`;
      tbody.appendChild(tr);
    });

  const diverg = findings.filter(f=>!f.match);
  document.getElementById('nc-text').innerHTML = buildNcText(diverg);

  const approved = fromHistory?.approved;
  const statusCell = document.getElementById('statusCell');
  if(approved){
    statusCell.innerHTML = '<span class="badge ok">APROVADO</span>';
  } else {
    statusCell.innerHTML = '<span class="badge error">REPROVADO POR CONTER NÃO CONFORMIDADES</span>';
  }

  document.getElementById('ts').textContent = fromHistory.ts;
  document.getElementById('hash').textContent = fromHistory.hash;

  localStorage.removeItem('bw_snapshot');
}

function baixarPDF(){
  const node = document.getElementById('capture');
  const opt = { 
    margin: 12, 
    filename: 'ATESTADO_DE_CONFORMIDADE_MAVIT.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true, letterRendering: true },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
  };
  html2pdf().set(opt).from(node).save();
}
fill();
</script>
</body>
</html>
